# MoFA Studio - Pixi Configuration
# Replaces setup_isolated_env.sh and install_all_packages.sh
# Usage: pixi install && pixi run setup

[project]
name = "mofa-studio"
version = "0.1.0"
description = "MoFA Studio - AI Voice Chat Application with Makepad UI and Dora dataflow"
channels = ["conda-forge", "pytorch"]
platforms = ["osx-arm64", "osx-64", "linux-64", "win-64"]

# =============================================================================
# CONDA DEPENDENCIES (from conda-forge and pytorch channels)
# =============================================================================

[dependencies]
# Python runtime
python = "3.12.*"

# PyTorch CPU (from pytorch channel) - version 2.2.0
pytorch = "2.2.0"
torchvision = "0.17.0"
torchaudio = "2.2.0"
cpuonly = "*"  # Ensure CPU-only PyTorch variant

# System libraries (from conda-forge)
portaudio = "*"
ffmpeg = "*"
openblas = "*"
openssl = "*"
git-lfs = "*"

# Build tools
gcc = "*"
gfortran = "*"

# LLM inference (conda-forge has pre-built wheels)
llama-cpp-python = "*"

# =============================================================================
# PYPI DEPENDENCIES
# =============================================================================

[pypi-dependencies]
# NumPy (pinned for compatibility with 1.x API)
numpy = "==1.26.4"

# Transformers ecosystem
transformers = "==4.45.0"
huggingface-hub = "==0.34.4"
datasets = "*"
accelerate = "*"
sentencepiece = "*"
protobuf = "*"
safetensors = "*"
einops = "*"

# Dora dataflow framework
dora-rs = "==0.3.12"

# Audio processing
pyarrow = "*"
scipy = "*"
librosa = "*"
soundfile = "*"
webrtcvad = "*"
pyaudio = "*"
sounddevice = "*"

# API clients
openai = "*"
websockets = "*"
aiohttp = "*"
requests = "*"

# Configuration
pyyaml = "*"
toml = "*"
python-dotenv = "*"

# TTS backend (CPU - cross-platform)
kokoro = "*"

# =============================================================================
# PLATFORM-SPECIFIC FEATURES
# =============================================================================

[feature.macos-mlx]
# MLX audio backend for Apple Silicon GPU acceleration
# Only available on macOS with Apple Silicon
platforms = ["osx-arm64"]
[feature.macos-mlx.pypi-dependencies]
mlx-audio = "*"

# =============================================================================
# ENVIRONMENTS
# =============================================================================

[environments]
# Default environment (CPU-only, cross-platform)
default = { solve-group = "default" }

# macOS with MLX acceleration (Apple Silicon)
macos-mlx = { features = ["macos-mlx"], solve-group = "default" }

# =============================================================================
# TASKS
# =============================================================================

[tasks]
# Full setup task - run after `pixi install`
setup = { depends-on = ["install-nodes", "install-dora-cli", "build-rust"] }

# Install local Python nodes in editable mode
install-nodes = """
pip install -e libs/dora-common && \
pip install -e node-hub/dora-asr && \
pip install -e node-hub/dora-primespeech && \
pip install -e node-hub/dora-kokoro-tts && \
pip install -e node-hub/dora-qwen3 && \
pip install -e node-hub/dora-text-segmenter && \
pip install -e node-hub/dora-speechmonitor
"""

# Install Dora CLI via cargo
install-dora-cli = "cargo install dora-cli --locked"

# Build Rust nodes
build-rust = { depends-on = ["build-maas-client", "build-conference-bridge", "build-conference-controller"] }

build-maas-client = "cargo build --release --manifest-path node-hub/dora-maas-client/Cargo.toml"
build-conference-bridge = "cargo build --release --manifest-path node-hub/dora-conference-bridge/Cargo.toml"
build-conference-controller = "cargo build --release --manifest-path node-hub/dora-conference-controller/Cargo.toml"

# Test tasks
test-deps = "python models/setup-local-models/test_dependencies.py"
test-tts = "cd models/setup-local-models/kokoro-tts-validation && ./run_all_tests.sh"

# Development tasks
dev = "cargo run --release"
run = "cargo run --release"  # Alias for launching the app
dora-up = "dora up"
dora-stop = "dora destroy"

# Start voice chat dataflow
start-voice-chat = "dora up && dora start examples/mac-aec-chat/voice-chat-with-aec.yml"

# Clean tasks
clean-rust = "cargo clean"
clean = { depends-on = ["clean-rust"] }

# =============================================================================
# ACTIVATION SCRIPTS
# =============================================================================

[activation]
# Environment variables set when environment is activated
scripts = ["scripts/activate.sh"]

# Set environment variables
[activation.env]
MOFA_STUDIO_ROOT = "$PIXI_PROJECT_ROOT"
PYTHONPATH = "$PIXI_PROJECT_ROOT/libs/dora-common:$PYTHONPATH"
