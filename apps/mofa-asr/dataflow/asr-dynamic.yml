# MoFA ASR Dataflow - Dual ASR Engines (Dynamic Nodes, Separate Processes)
#
# Pipeline: Mic → [Paraformer + SenseVoice] → Chat Output → UI
#
# All nodes are dynamic. ASR engines are spawned as separate child processes
# by mofa-asr (using --name flag for init_from_node_id). This avoids MLX
# Metal GPU crashes from concurrent thread access while allowing ON/OFF toggle.

nodes:
  # Mic Input - captures audio with AEC (echo cancellation)
  - id: mofa-mic-input
    path: dynamic
    outputs:
      - audio_segment
      - speech_started
      - speech_ended
      - is_speaking
      - question_ended
      - status
      - log

  # ASR 1 - Paraformer (Chinese, fast) - spawned as child process
  - id: mofa-asr-paraformer
    path: dynamic
    inputs:
      audio: mofa-mic-input/audio_segment
    outputs:
      - transcription
      - language_detected
      - processing_time
      - log

  # ASR 2 - SenseVoice (multilingual) - spawned as child process
  - id: mofa-asr-sensevoice
    path: dynamic
    inputs:
      audio: mofa-mic-input/audio_segment
    outputs:
      - transcription
      - language_detected
      - processing_time
      - log

  # ASR 3 - StepAudio2 (multilingual, Whisper+Qwen) - spawned as child process
  - id: mofa-asr-stepaudio2
    path: dynamic
    inputs:
      audio: mofa-mic-input/audio_segment
    outputs:
      - transcription
      - language_detected
      - processing_time
      - log

  # Chat Output - receives ASR transcriptions for per-engine chat display
  - id: mofa-chat-output
    path: dynamic
    inputs:
      paraformer_text:
        source: mofa-asr-paraformer/transcription
        queue_size: 1000
      sensevoice_text:
        source: mofa-asr-sensevoice/transcription
        queue_size: 1000
      stepaudio2_text:
        source: mofa-asr-stepaudio2/transcription
        queue_size: 1000
    outputs:
      - control

  # System Log - aggregates logs from all nodes
  - id: mofa-system-log
    path: dynamic
    inputs:
      paraformer_log:
        source: mofa-asr-paraformer/log
        queue_size: 1000
      paraformer_text:
        source: mofa-asr-paraformer/transcription
        queue_size: 1000
      sensevoice_log:
        source: mofa-asr-sensevoice/log
        queue_size: 1000
      sensevoice_text:
        source: mofa-asr-sensevoice/transcription
        queue_size: 1000
      stepaudio2_log:
        source: mofa-asr-stepaudio2/log
        queue_size: 1000
      stepaudio2_text:
        source: mofa-asr-stepaudio2/transcription
        queue_size: 1000
      mic_input_log:
        source: mofa-mic-input/log
        queue_size: 1000
      mic_input_status: mofa-mic-input/status
